"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const request = require("request");
const cheerio = require("cheerio");
const chalk = require("chalk");
const _ = require("lodash");
const validUrl = require('valid-url');
const helpers_1 = require("./helpers");
class CSPANVideos {
    constructor() {
        this.CSPAN_BASE_URL = "https://www.c-span.org/person/?";
        this.CSPAN_BAD_URL = "https://www.c-span.org/search/?searchtype=People&query=";
    }
    fetchVideoData(personName) {
        const name = personName;
        // if "name" is an error;
        if (typeof name !== "string") {
            console.error(chalk.bgRed("rejecting because name isn't a string"), name);
            return;
        }
        return this._makeRequest(name)
            .then(this._isBadURL)
            .then((data) => {
            return data
                ? this._makeSearchRequest(personName)
                : this._makeRequest(name);
        })
            .then((data) => {
            if (data instanceof Error) {
                return Promise.reject(data);
            }
            /**
             * If this string is present, then we are on
             * the intended page.
             */
            return data.indexOf('Recent Appearances') !== -1
                ? this._parseRequestForData(data)
                : this._parseSearchPageForData(data);
        })
            .then((data) => {
            return typeof data === "string"
                ? this._makeRequest(name, null, data)
                : Promise.resolve(data);
        })
            .catch((err) => {
            console.warn(chalk.magenta("There was an error, catch", err));
            return err;
        });
    }
    _isBadURL(dom) {
        const $ = cheerio.load(dom);
        return Promise.resolve($('body').html().indexOf("Page Not Found") > -1);
    }
    /**
     * For when the url differs from the person's name
     * like Ted Cruz being "rcruz."
     */
    _makeSearchRequest(personName) {
        if (!personName) {
            return Promise.reject("Name not provided");
        }
        return this._makeRequest(personName, true);
    }
    _makeRequest(personName, badURL, newUrl) {
        // Add try/catch?
        if (!personName) {
            return Promise.reject(new Error("No person name provided"));
        }
        const name = !badURL
            ? helpers_1.formatPersonName(personName)
            : helpers_1.formatPersonName(personName, true);
        const base_url = newUrl
            ? newUrl
            : !badURL
                ? this.CSPAN_BASE_URL + name
                : this.CSPAN_BAD_URL + personName.replace(/\s/, "+");
        if (!name) {
            return Promise.reject(name);
        }
        return new Promise((resolve, reject) => {
            request(base_url, (err, response, body) => {
                if (err) {
                    handleError(err);
                    reject(err);
                }
                else {
                    resolve(body);
                }
            });
        });
    }
    _parseSearchPageForData(dom) {
        const $ = cheerio.load(dom);
        let properURL = $('section.bios > ul > li.indiv_bio > a.thumb')
            .first()
            .attr('href');
        if (!properURL) {
            return new Error("Bad name format provided");
        }
        if (_.startsWith(properURL, "//")) {
            properURL = "https:" + properURL;
        }
        return properURL;
    }
    _parseRequestForData(dom) {
        const $ = cheerio.load(dom);
        const recentPrograms = [];
        const recentProgramsHolder = $('ul.recent-programs > li');
        for (var i = 0; i < recentProgramsHolder.length; i++) {
            const singleVideo = {};
            const container = recentProgramsHolder
                .eq(i);
            singleVideo.thumbnail = container
                .find('a.thumb > img')
                .attr("src");
            singleVideo.title = container
                .find('div.text > a.title > h3')
                .text();
            singleVideo.date = container
                .find("div.text > span.time > time")
                .text();
            singleVideo.video_url = container
                .find("a.thumb")
                .attr("href");
            singleVideo.embed_url = helpers_1.formatEmbedURL(singleVideo.video_url);
            recentPrograms.push(singleVideo);
        }
        return recentPrograms;
    }
}
function handleError(err) {
    console.error("There was an error: ", err);
}
const cspanvids = new CSPANVideos();
exports.cspanvids = cspanvids;
/**
 * TODO: Cache request info from search page to cut down
 * on number of requests.
 */ 

//# sourceMappingURL=data:application/json;charset=utf8;base64,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RUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBRVQsV0FBVyxDQUFDLFNBQVMsR0FBRyxTQUFTO2lCQUM5QixJQUFJLENBQUMsZUFBZSxDQUFDO2lCQUNyQixJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7WUFFZixXQUFXLENBQUMsS0FBSyxHQUFHLFNBQVM7aUJBQzFCLElBQUksQ0FBQyx5QkFBeUIsQ0FBQztpQkFDL0IsSUFBSSxFQUFFLENBQUM7WUFFVixXQUFXLENBQUMsSUFBSSxHQUFHLFNBQVM7aUJBQ3pCLElBQUksQ0FBQyw2QkFBNkIsQ0FBQztpQkFDbkMsSUFBSSxFQUFFLENBQUM7WUFFVixXQUFXLENBQUMsU0FBUyxHQUFHLFNBQVM7aUJBQzlCLElBQUksQ0FBQyxTQUFTLENBQUM7aUJBQ2YsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBRWhCLFdBQVcsQ0FBQyxTQUFTLEdBQUcsd0JBQWMsQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDLENBQUM7WUFFOUQsY0FBYyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUNuQyxDQUFDO1FBRUQsTUFBTSxDQUFDLGNBQWMsQ0FBQztJQUN4QixDQUFDO0NBQ0Y7QUFFRCxxQkFBcUIsR0FBVTtJQUM3QixPQUFPLENBQUMsS0FBSyxDQUFDLHNCQUFzQixFQUFFLEdBQUcsQ0FBQyxDQUFDO0FBQzdDLENBQUM7QUFFRCxNQUFNLFNBQVMsR0FBRyxJQUFJLFdBQVcsRUFBRSxDQUFDO0FBQzNCLDhCQUFTO0FBVWxCOzs7R0FHRyIsImZpbGUiOiJzcmMvY3NwYW52aWRlb3MuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyByZXF1ZXN0IGZyb20gJ3JlcXVlc3QnO1xuaW1wb3J0ICogYXMgY2hlZXJpbyBmcm9tICdjaGVlcmlvJztcbmltcG9ydCAqIGFzIGNoYWxrIGZyb20gJ2NoYWxrJztcbmltcG9ydCAqIGFzIF8gZnJvbSAnbG9kYXNoJztcblxuY29uc3QgdmFsaWRVcmwgPSByZXF1aXJlKCd2YWxpZC11cmwnKTtcblxuaW1wb3J0IHsgZm9ybWF0UGVyc29uTmFtZSwgZm9ybWF0RW1iZWRVUkwgfSBmcm9tICcuL2hlbHBlcnMnO1xuXG5jbGFzcyBDU1BBTlZpZGVvcyB7XG4gIENTUEFOX0JBU0VfVVJMOiBzdHJpbmcgPSBcImh0dHBzOi8vd3d3LmMtc3Bhbi5vcmcvcGVyc29uLz9cIjtcbiAgQ1NQQU5fQkFEX1VSTDogc3RyaW5nID0gXCJodHRwczovL3d3dy5jLXNwYW4ub3JnL3NlYXJjaC8/c2VhcmNodHlwZT1QZW9wbGUmcXVlcnk9XCI7XG4gIFxuXG4gIGZldGNoVmlkZW9EYXRhKHBlcnNvbk5hbWU6IHN0cmluZykge1xuICAgIGNvbnN0IG5hbWUgPSBwZXJzb25OYW1lO1xuXG4gICAgLy8gaWYgXCJuYW1lXCIgaXMgYW4gZXJyb3I7XG4gICAgaWYgKHR5cGVvZiBuYW1lICE9PSBcInN0cmluZ1wiKSB7XG4gICAgICBjb25zb2xlLmVycm9yKGNoYWxrLmJnUmVkKFwicmVqZWN0aW5nIGJlY2F1c2UgbmFtZSBpc24ndCBhIHN0cmluZ1wiKSwgbmFtZSlcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5fbWFrZVJlcXVlc3QobmFtZSlcbiAgICAgIC50aGVuKHRoaXMuX2lzQmFkVVJMKVxuICAgICAgLnRoZW4oKGRhdGEpID0+IHtcbiAgICAgICAgcmV0dXJuIGRhdGFcbiAgICAgICAgICA/IHRoaXMuX21ha2VTZWFyY2hSZXF1ZXN0KHBlcnNvbk5hbWUpXG4gICAgICAgICAgOiB0aGlzLl9tYWtlUmVxdWVzdChuYW1lKVxuICAgICAgfSlcbiAgICAgIC50aGVuKChkYXRhKSA9PiB7XG5cbiAgICAgICAgaWYgKCBkYXRhIGluc3RhbmNlb2YgRXJyb3IpIHtcbiAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoZGF0YSk7XG4gICAgICAgIH1cbiAgICAgICAgLyoqXG4gICAgICAgICAqIElmIHRoaXMgc3RyaW5nIGlzIHByZXNlbnQsIHRoZW4gd2UgYXJlIG9uXG4gICAgICAgICAqIHRoZSBpbnRlbmRlZCBwYWdlLlxuICAgICAgICAgKi9cbiAgICAgICAgcmV0dXJuIGRhdGEuaW5kZXhPZignUmVjZW50IEFwcGVhcmFuY2VzJykgIT09IC0xXG4gICAgICAgICAgPyB0aGlzLl9wYXJzZVJlcXVlc3RGb3JEYXRhKGRhdGEpXG4gICAgICAgICAgOiB0aGlzLl9wYXJzZVNlYXJjaFBhZ2VGb3JEYXRhKGRhdGEpXG4gICAgICB9KVxuICAgICAgLnRoZW4oKGRhdGEpID0+IHtcbiAgICAgICAgcmV0dXJuIHR5cGVvZiBkYXRhID09PSBcInN0cmluZ1wiXG4gICAgICAgICAgPyB0aGlzLl9tYWtlUmVxdWVzdChuYW1lLCBudWxsLCBkYXRhKVxuICAgICAgICAgIDogUHJvbWlzZS5yZXNvbHZlKGRhdGEpO1xuICAgICAgfSlcbiAgICAgIC5jYXRjaCgoZXJyKSA9PiB7XG4gICAgICAgIGNvbnNvbGUud2FybihjaGFsay5tYWdlbnRhKFwiVGhlcmUgd2FzIGFuIGVycm9yLCBjYXRjaFwiLCBlcnIpKVxuICAgICAgICByZXR1cm4gZXJyO1xuICAgICAgfSlcbiAgICAgIFxuICB9XG5cbiAgX2lzQmFkVVJMKGRvbTogc3RyaW5nKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgY29uc3QgJCA9IGNoZWVyaW8ubG9hZChkb20pO1xuICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoJCgnYm9keScpLmh0bWwoKS5pbmRleE9mKFwiUGFnZSBOb3QgRm91bmRcIikgPiAtMSlcbiAgfVxuXG4gIC8qKlxuICAgKiBGb3Igd2hlbiB0aGUgdXJsIGRpZmZlcnMgZnJvbSB0aGUgcGVyc29uJ3MgbmFtZVxuICAgKiBsaWtlIFRlZCBDcnV6IGJlaW5nIFwicmNydXouXCJcbiAgICovXG4gIF9tYWtlU2VhcmNoUmVxdWVzdChwZXJzb25OYW1lOiBzdHJpbmcpOiBhbnkge1xuICAgIGlmICggIXBlcnNvbk5hbWUgKSB7XG4gICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoXCJOYW1lIG5vdCBwcm92aWRlZFwiKTtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5fbWFrZVJlcXVlc3QocGVyc29uTmFtZSwgdHJ1ZSk7XG4gIH1cblxuICBfbWFrZVJlcXVlc3QocGVyc29uTmFtZTogc3RyaW5nLCBiYWRVUkw/OiBib29sZWFuLCBuZXdVcmw/KSB7XG4gICAgXG4gICAgLy8gQWRkIHRyeS9jYXRjaD9cbiAgICBpZiAoICFwZXJzb25OYW1lICkge1xuICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KG5ldyBFcnJvcihcIk5vIHBlcnNvbiBuYW1lIHByb3ZpZGVkXCIpKTtcbiAgICB9IFxuXG4gICAgY29uc3QgbmFtZSA9ICFiYWRVUkxcbiAgICA/IGZvcm1hdFBlcnNvbk5hbWUocGVyc29uTmFtZSlcbiAgICA6IGZvcm1hdFBlcnNvbk5hbWUocGVyc29uTmFtZSwgdHJ1ZSlcbiAgICBcbiAgICBjb25zdCBiYXNlX3VybCA9IG5ld1VybCBcbiAgICA/IG5ld1VybCBcbiAgICA6ICFiYWRVUkxcbiAgICAgID8gdGhpcy5DU1BBTl9CQVNFX1VSTCArIG5hbWVcbiAgICAgIDogdGhpcy5DU1BBTl9CQURfVVJMICsgcGVyc29uTmFtZS5yZXBsYWNlKC9cXHMvLFwiK1wiKTtcblxuICAgIGlmICghbmFtZSkge1xuICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KG5hbWUpXG4gICAgfVxuXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIHJlcXVlc3QoYmFzZV91cmwgLCAoZXJyOiBFcnJvciwgcmVzcG9uc2U6IHJlcXVlc3QuUmVxdWVzdFJlc3BvbnNlLCBib2R5OiBzdHJpbmcpID0+IHtcbiAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgIGhhbmRsZUVycm9yKGVycik7XG4gICAgICAgICAgcmVqZWN0KGVycik7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmVzb2x2ZShib2R5KTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cbiAgXG4gIF9wYXJzZVNlYXJjaFBhZ2VGb3JEYXRhKGRvbTogc3RyaW5nKSB7XG4gICAgY29uc3QgJCA9IGNoZWVyaW8ubG9hZChkb20pO1xuICAgIGxldCBwcm9wZXJVUkwgPSAkKCdzZWN0aW9uLmJpb3MgPiB1bCA+IGxpLmluZGl2X2JpbyA+IGEudGh1bWInKVxuICAgICAgLmZpcnN0KClcbiAgICAgIC5hdHRyKCdocmVmJyk7XG5cbiAgICBpZiAoICFwcm9wZXJVUkwgKSB7XG4gICAgICByZXR1cm4gbmV3IEVycm9yKFwiQmFkIG5hbWUgZm9ybWF0IHByb3ZpZGVkXCIpXG4gICAgfVxuXG4gICAgaWYgKCBfLnN0YXJ0c1dpdGgocHJvcGVyVVJMLCBcIi8vXCIpKSB7XG4gICAgICBwcm9wZXJVUkwgPSBcImh0dHBzOlwiICsgcHJvcGVyVVJMO1xuICAgIH1cblxuICAgIHJldHVybiBwcm9wZXJVUkw7XG4gIH1cblxuICBfcGFyc2VSZXF1ZXN0Rm9yRGF0YShkb206IHN0cmluZykge1xuICAgIGNvbnN0ICQgPSBjaGVlcmlvLmxvYWQoZG9tKTtcbiAgICBjb25zdCByZWNlbnRQcm9ncmFtczogSVNpbmdsZVZpZGVvW10gPSBbXTtcbiAgICBjb25zdCByZWNlbnRQcm9ncmFtc0hvbGRlciA9ICQoJ3VsLnJlY2VudC1wcm9ncmFtcyA+IGxpJyk7XG5cbiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJlY2VudFByb2dyYW1zSG9sZGVyLmxlbmd0aDsgaSsrKSB7XG4gICAgICBjb25zdCBzaW5nbGVWaWRlbzogSVNpbmdsZVZpZGVvID0ge307XG5cbiAgICAgIGNvbnN0IGNvbnRhaW5lciA9IHJlY2VudFByb2dyYW1zSG9sZGVyXG4gICAgICAgIC5lcShpKTtcblxuICAgICAgc2luZ2xlVmlkZW8udGh1bWJuYWlsID0gY29udGFpbmVyXG4gICAgICAgIC5maW5kKCdhLnRodW1iID4gaW1nJylcbiAgICAgICAgLmF0dHIoXCJzcmNcIik7XG5cbiAgICAgIHNpbmdsZVZpZGVvLnRpdGxlID0gY29udGFpbmVyXG4gICAgICAgIC5maW5kKCdkaXYudGV4dCA+IGEudGl0bGUgPiBoMycpXG4gICAgICAgIC50ZXh0KCk7XG5cbiAgICAgIHNpbmdsZVZpZGVvLmRhdGUgPSBjb250YWluZXJcbiAgICAgICAgLmZpbmQoXCJkaXYudGV4dCA+IHNwYW4udGltZSA+IHRpbWVcIilcbiAgICAgICAgLnRleHQoKTtcblxuICAgICAgc2luZ2xlVmlkZW8udmlkZW9fdXJsID0gY29udGFpbmVyXG4gICAgICAgIC5maW5kKFwiYS50aHVtYlwiKVxuICAgICAgICAuYXR0cihcImhyZWZcIik7XG5cbiAgICAgIHNpbmdsZVZpZGVvLmVtYmVkX3VybCA9IGZvcm1hdEVtYmVkVVJMKHNpbmdsZVZpZGVvLnZpZGVvX3VybCk7XG5cbiAgICAgIHJlY2VudFByb2dyYW1zLnB1c2goc2luZ2xlVmlkZW8pO1xuICAgIH1cblxuICAgIHJldHVybiByZWNlbnRQcm9ncmFtcztcbiAgfVxufVxuXG5mdW5jdGlvbiBoYW5kbGVFcnJvcihlcnI6IEVycm9yKSB7XG4gIGNvbnNvbGUuZXJyb3IoXCJUaGVyZSB3YXMgYW4gZXJyb3I6IFwiLCBlcnIpO1xufVxuXG5jb25zdCBjc3BhbnZpZHMgPSBuZXcgQ1NQQU5WaWRlb3MoKTtcbmV4cG9ydCB7IGNzcGFudmlkcyB9XG5cbmludGVyZmFjZSBJU2luZ2xlVmlkZW8ge1xuICB0aHVtYm5haWw/OiBzdHJpbmcsXG4gIHRpdGxlPzogc3RyaW5nLFxuICBkYXRlPzogc3RyaW5nLFxuICBlbWJlZF91cmw/OiBzdHJpbmcsXG4gIHZpZGVvX3VybD86IHN0cmluZ1xufVxuXG4vKipcbiAqIFRPRE86IENhY2hlIHJlcXVlc3QgaW5mbyBmcm9tIHNlYXJjaCBwYWdlIHRvIGN1dCBkb3duXG4gKiBvbiBudW1iZXIgb2YgcmVxdWVzdHMuXG4gKi8iXX0=
